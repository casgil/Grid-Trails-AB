<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Trails Task | jsPsych v8 Portable</title>

    <!-- Load jsPsych from CDN (Portable) -->
    <script src="https://unpkg.com/jspsych@8.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-instructions@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@2.0.0"></script>

    <!-- Custom Plugin (Inlined for Portability) -->
    <script>
        var jsPsychTrails = (function (jspsych) {
            'use strict';

            const info = {
                name: "trails",
                version: "1.0.0",
                parameters: {
                    grid_size: {
                        type: jspsych.ParameterType.INT,
                        default: 4,
                        description: "Dimension of the grid (e.g., 4 for 4x4)"
                    },
                    trails_type: {
                        type: jspsych.ParameterType.STRING,
                        default: "A", // "A" (Numbers) or "B" (Numbers/Letters)
                        description: "Type of trails task"
                    },
                    correct_order: {
                        type: jspsych.ParameterType.COMPLEX,
                        default: [],
                        description: "Array of correct values in order"
                    },
                    random_order: {
                        type: jspsych.ParameterType.COMPLEX,
                        default: [],
                        description: "Array of values defining the grid layout"
                    }
                }
            };

            class TrailsPlugin {
                constructor(jsPsych) {
                    this.jsPsych = jsPsych;
                }

                trial(display_element, trial) {
                    // Styles are already loaded in main HTML (grid_trails_modern.html styles)
                    // We will reuse those classes: .card, .status-bar, #game-board, .cell, .cell.correct, .cell.error-shake

                    // State
                    let currentIndex = 0;
                    let errors = 0;
                    let startTime = null;
                    let timerInterval = null;

                    // Render
                    // We wrap everything in a .card to match the modern look
                    let html = `
            <div class="card">
                <div class="status-bar" style="margin: 0 auto 1rem auto;">
                    <span id="game-part">Part ${trial.trails_type}</span>
                    <span>Time: <span id="timer">0.0</span>s</span>
                </div>
                <div id="game-board" style="margin: 0 auto 2rem auto;">
                    ${trial.random_order.map((val, index) =>
                        `<div class="cell" data-value="${val}" data-index="${index}">${val}</div>`
                    ).join('')}
                </div>
                <div id="feedback-msg" style="height: 1.5rem; color: var(--error-color); font-weight: 600; opacity: 0; transition: opacity 0.2s;">Incorrect!</div>
            </div>
          `;

                    display_element.innerHTML = html;

                    const cells = display_element.querySelectorAll('.cell');
                    const feedbackEl = display_element.querySelector('#feedback-msg');
                    const timerEl = display_element.querySelector('#timer');

                    // Data Logging State
                    const click_events = []; // Stores manual clicks

                    // Helper: Get Grid Coordinates (1-based)
                    const getCoords = (index) => {
                        const row = Math.floor(index / trial.grid_size) + 1;
                        const col = (index % trial.grid_size) + 1;
                        return { row, col };
                    };

                    // Timer Logic
                    const updateTimer = () => {
                        if (!startTime) return;
                        const delta = (performance.now() - startTime) / 1000;
                        timerEl.textContent = delta.toFixed(1);
                    };

                    // Interaction
                    const handleCellClick = (e) => {
                        const cell = e.target;
                        if (cell.classList.contains('correct')) return;

                        // Start timer on first interaction
                        if (startTime === null) {
                            startTime = performance.now();
                            timerInterval = setInterval(updateTimer, 100);
                        }

                        const currentTime = performance.now();
                        const timeFromStart = currentTime - startTime;

                        const value = cell.dataset.value;
                        const index = parseInt(cell.dataset.index, 10);
                        const coords = getCoords(index);
                        const target = String(trial.correct_order[currentIndex]);

                        const isCorrect = String(value) === target;

                        // Log Event
                        click_events.push({
                            timestamp: Math.round(timeFromStart),
                            value: value,
                            correct: isCorrect,
                            row: coords.row,
                            col: coords.col
                        });

                        if (isCorrect) {
                            // Correct
                            cell.classList.add('correct');
                            cell.classList.remove('error-shake'); // Clear any error state
                            feedbackEl.classList.remove('show');
                            feedbackEl.style.opacity = '0';
                            currentIndex++;

                            // Check completion
                            if (currentIndex >= trial.correct_order.length) {
                                endTrial();
                            }
                        } else {
                            // Incorrect
                            errors++;
                            cell.classList.add('error-shake');

                            // Feedback
                            let hint = "";
                            if (currentIndex === 0) {
                                hint = `Start with "${target}"`;
                            } else {
                                const prev = trial.correct_order[currentIndex - 1];
                                hint = `After ${prev}, find "${target}"`;
                            }
                            feedbackEl.textContent = `Incorrect! ${hint}`;
                            feedbackEl.style.opacity = '1';

                            setTimeout(() => {
                                cell.classList.remove('error-shake');
                            }, 500);
                        }
                    };

                    // Attach listeners
                    cells.forEach(cell => {
                        cell.addEventListener('click', handleCellClick);
                    });

                    const endTrial = () => {
                        if (timerInterval) clearInterval(timerInterval);
                        const endTime = performance.now();
                        const rt = endTime - startTime;

                        // Calculate functionality coordinates for the Correct Path
                        const correct_path_coords = trial.correct_order.map(val => {
                            const idx = trial.random_order.indexOf(val);
                            return getCoords(idx);
                        });

                        const trial_data = {
                            rt: rt,
                            errors: errors,
                            trails_type: trial.trails_type,
                            grid_size: trial.grid_size,
                            // Store lists as JSON strings
                            click_history: JSON.stringify(click_events),
                            correct_path: JSON.stringify(correct_path_coords)
                        };

                        // Clear display
                        display_element.innerHTML = '';

                        // Finish
                        this.jsPsych.finishTrial(trial_data);
                    };
                }
            }

            TrailsPlugin.info = info;

            return TrailsPlugin;

        })(jsPsychModule);
    </script>

    <style>
        /* --- MODERN STYLES PORTED FROM grid_trails_modern.html --- */
        :root {
            --primary-color: #4F46E5;
            --primary-hover: #4338ca;
            --bg-color: #F3F4F6;
            --card-bg: #ffffff;
            --text-color: #1F2937;
            --text-light: #6B7280;
            --error-color: #EF4444;
            --success-color: #10B981;
            --cell-size: 80px;
            --gap-size: 15px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px 0;
            margin: 0;
        }

        /* jsPsych cleanup */
        .jspsych-content-wrapper {
            display: flex;
            margin: auto;
            flex: 1 1 100%;
            width: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            /* Ensure vertical stacking for appended elements */
        }

        .jspsych-content {
            max-width: 95%;
            text-align: center;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            text-align: center;
            margin: auto;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1.5rem;
            color: #111827;
            letter-spacing: -0.025em;
        }

        h2 {
            font-size: 1.8rem;
            color: #374151;
            margin-bottom: 1rem;
        }

        p {
            font-size: 1.125rem;
            line-height: 1.75;
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        /* Buttons (overriding jsPsych defaults) */
        .jspsych-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 32px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-family: inherit;
        }

        .jspsych-btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
        }

        /* Inputs */
        input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            font-size: 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 8px;
            transition: all 0.2s;
            outline: none;
            margin-bottom: 20px;
        }

        /* Game Grid */
        #game-board {
            display: grid;
            grid-template-columns: repeat(4, var(--cell-size));
            grid-template-rows: repeat(4, var(--cell-size));
            gap: var(--gap-size);
            margin-bottom: 2rem;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin: 0 auto 2rem auto;
            width: fit-content;
            /* Centered */
        }

        .cell {
            width: var(--cell-size);
            height: var(--cell-size);
            background-color: #E5E7EB;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            font-weight: 700;
            color: #374151;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }

        .cell:hover {
            transform: scale(1.05);
            background-color: #D1D5DB;
        }

        .cell:active {
            transform: scale(0.95);
        }

        .cell.correct {
            background-color: #9CA3AF;
            color: #F3F4F6;
            cursor: default;
            transform: none;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        .cell.error-shake {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
            background-color: #FECACA !important;
            color: #991B1B !important;
        }

        /* Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-bottom: 1rem;
            font-weight: 500;
            color: var(--text-light);
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* --- ANIMATIONS & DEMO GRID --- */
        .demo-board-wrapper {
            position: relative;
            width: fit-content;
            margin: 20px auto;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(4, 40px);
            gap: 8px;
            justify-content: center;
        }

        .demo-cell {
            width: 40px;
            height: 40px;
            background-color: #E5E7EB;
            border-radius: 6px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            color: #374151;
            font-size: 1rem;
        }

        .demo-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: rgba(255, 0, 0, 0.7);
            border-radius: 50%;
            pointer-events: none;
            top: 0;
            left: 0;
            transform: translate(-50%, -50%);
            z-index: 10;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        @keyframes cursorMoveA {
            0% {
                top: 150%;
                left: 150%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            20% {
                top: 20px;
                left: 20px;
                transform: scale(1);
            }

            25% {
                transform: scale(0.8);
            }

            30% {
                transform: scale(1);
            }

            40% {
                top: 68px;
                left: 68px;
                transform: scale(1);
            }

            45% {
                transform: scale(0.8);
            }

            50% {
                transform: scale(1);
            }

            60% {
                top: 20px;
                left: 116px;
                transform: scale(1);
            }

            65% {
                transform: scale(0.8);
            }

            70% {
                transform: scale(1);
            }

            80% {
                top: 116px;
                left: 116px;
                transform: scale(1);
            }

            85% {
                transform: scale(0.8);
            }

            90% {
                transform: scale(1);
            }

            95% {
                opacity: 1;
            }

            100% {
                top: 116px;
                left: 116px;
                opacity: 0;
            }
        }

        @keyframes cursorMoveB {
            0% {
                top: 150%;
                left: 150%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            20% {
                top: 20px;
                left: 20px;
                transform: scale(1);
            }

            25% {
                transform: scale(0.8);
            }

            30% {
                transform: scale(1);
            }

            40% {
                top: 68px;
                left: 68px;
                transform: scale(1);
            }

            45% {
                transform: scale(0.8);
            }

            50% {
                transform: scale(1);
            }

            60% {
                top: 20px;
                left: 116px;
                transform: scale(1);
            }

            65% {
                transform: scale(0.8);
            }

            70% {
                transform: scale(1);
            }

            80% {
                top: 116px;
                left: 116px;
                transform: scale(1);
            }

            85% {
                transform: scale(0.8);
            }

            90% {
                transform: scale(1);
            }

            95% {
                opacity: 1;
            }

            100% {
                top: 116px;
                left: 116px;
                opacity: 0;
            }
        }

        .cursor-anim-a {
            animation: cursorMoveA 4s infinite;
        }

        .cursor-anim-b {
            animation: cursorMoveB 4s infinite;
        }

        @keyframes cellActive1 {

            0%,
            20% {
                background-color: #E5E7EB;
                color: #374151;
            }

            25% {
                transform: scale(0.95);
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            30% {
                transform: scale(1);
            }

            95% {
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            100% {
                background-color: #E5E7EB;
                color: #374151;
            }
        }

        @keyframes cellActive2 {

            0%,
            40% {
                background-color: #E5E7EB;
                color: #374151;
            }

            45% {
                transform: scale(0.95);
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            50% {
                transform: scale(1);
            }

            95% {
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            100% {
                background-color: #E5E7EB;
                color: #374151;
            }
        }

        @keyframes cellActive3 {

            0%,
            60% {
                background-color: #E5E7EB;
                color: #374151;
            }

            65% {
                transform: scale(0.95);
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            70% {
                transform: scale(1);
            }

            95% {
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            100% {
                background-color: #E5E7EB;
                color: #374151;
            }
        }

        @keyframes cellActive4 {

            0%,
            80% {
                background-color: #E5E7EB;
                color: #374151;
            }

            85% {
                transform: scale(0.95);
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            90% {
                transform: scale(1);
            }

            95% {
                background-color: #9CA3AF;
                color: #F3F4F6;
            }

            100% {
                background-color: #E5E7EB;
                color: #374151;
            }
        }

        .demo-active-1 {
            animation: cellActive1 4s infinite;
        }

        .demo-active-2 {
            animation: cellActive2 4s infinite;
        }

        .demo-active-3 {
            animation: cellActive3 4s infinite;
        }

        .demo-active-4 {
            animation: cellActive4 4s infinite;
        }

        /* Results Table */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 1rem;
        }

        th,
        td {
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
            text-align: center;
        }

        th {
            font-weight: 600;
            color: var(--primary-color);
        }

        td:first-child,
        th:first-child {
            text-align: left;
            font-weight: 500;
            color: var(--text-color);
        }

        /* Responsive */
        @media (max-width: 480px) {
            :root {
                --cell-size: 60px;
                --gap-size: 10px;
            }

            h1 {
                font-size: 1.8rem;
            }

            .card {
                padding: 20px;
            }
        }

        /* Landscape / Short Screen Optimization */
        @media (max-height: 600px) {
            :root {
                --cell-size: 50px;
                --gap-size: 8px;
            }

            .card {
                padding: 15px;
                margin: 10px auto;
            }

            h1 {
                font-size: 1.5rem;
                margin-bottom: 0.5rem;
            }

            h2 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
            }

            p {
                margin-bottom: 1rem;
                font-size: 1rem;
            }

            #game-board {
                margin-bottom: 1rem;
                padding: 10px;
            }

            .jspsych-btn {
                padding: 8px 20px;
            }
        }

        /* Touch Optimizations */
        body {
            overscroll-behavior: none;
            /* Prevent bounce */
        }

        button,
        .jspsych-btn,
        .cell {
            touch-action: manipulation;
            /* Remove 300ms delay */
        }
    </style>
</head>

<body></body>
<script>
    // Initialize jsPsych
    const jsPsych = initJsPsych();

    // Global skip flags
    window.skipA = false;
    window.skipB = false;

    window.doSkip = function (part) {
        if (part === 'A') window.skipA = true;
        if (part === 'B') window.skipB = true;
        jsPsych.finishTrial();
    };

    // Helper to cleanup skip button
    const removeSkipButton = () => {
        const existing = document.getElementById('skip-btn-container');
        if (existing) existing.remove();
    };

    // Helper to add Skip Button below nav
    const addSkipButton = (part) => {
        const content = document.querySelector('.jspsych-content-wrapper'); // Append to wrapper to be below content
        if (!content) return;

        // Remove existing button first to avoid persistence or duplicates
        removeSkipButton();

        // Create skip container (centered, distinct)
        const skipContainer = document.createElement('div');
        skipContainer.id = 'skip-btn-container';
        skipContainer.style.marginTop = '30px';
        skipContainer.style.display = 'flex';
        skipContainer.style.justifyContent = 'center';
        skipContainer.style.zIndex = '1000';

        // Create the button/link
        const skipLink = document.createElement('button');
        skipLink.textContent = "Skip Instructions";
        skipLink.className = 'jspsych-btn';
        // Modern secondary button style
        skipLink.style.backgroundColor = 'transparent';
        skipLink.style.color = '#6B7280';
        skipLink.style.border = '2px solid #E5E7EB';
        skipLink.style.fontSize = '0.9rem';
        skipLink.style.padding = '8px 24px';
        skipLink.style.borderRadius = '50px'; // Rounded pill shape
        skipLink.style.cursor = 'pointer';
        skipLink.style.transition = 'all 0.2s ease';
        skipLink.style.fontWeight = '600';

        // Hover effect helper
        skipLink.onmouseenter = () => {
            skipLink.style.color = '#374151';
            skipLink.style.borderColor = '#9CA3AF';
            skipLink.style.transform = 'translateY(-1px)';
        };
        skipLink.onmouseleave = () => {
            skipLink.style.color = '#6B7280';
            skipLink.style.borderColor = '#E5E7EB';
            skipLink.style.transform = 'none';
        };

        skipLink.onclick = () => window.doSkip(part);

        skipContainer.appendChild(skipLink);

        // Append to the content wrapper so it sits below the main content area (and thus buttons)
        content.appendChild(skipContainer);
    };

    // Timeline
    const timeline = [];

    // 1. Participant ID - REMOVED PER USER REQUEST
    // const participant_node = {
    //     type: jsPsychSurveyText,
    //     questions: [{ prompt: "<h2>Grid Trails Task</h2><p>Please enter your Participant ID:</p>", required: true }],
    //     button_label: "Begin Task",
    //     on_load: function () {
    //         const content = document.querySelector('.jspsych-content');
    //         if (content) content.classList.add('card');
    //     }
    // };
    // timeline.push(participant_node);

    // 2. Fullscreen - Removed per user request
    // timeline.push({
    //     type: jsPsychFullscreen,
    //     fullscreen_mode: true
    // });

    // --- UTILS ---
    const generateSequenceA = () => Array.from({ length: 16 }, (_, i) => i + 1);
    const generateSequenceB = () => {
        const seq = [];
        for (let i = 1; i <= 8; i++) {
            seq.push(i);
            seq.push(String.fromCharCode(64 + i)); // A, B, C...
        }
        return seq;
    };
    const shuffle = (array) => {
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
    };

    // --- PART A ---
    // Instructions Part 1 (Demo)
    const instructionsA_intro = {
        type: jsPsychInstructions,
        pages: [
            `<div class="card">
                <h1>Welcome to the Grid Trails Task</h1>
                <h2>Part A: Numbers</h2>
                <p>In this task, you will see a grid of numbers from 1 to 16.</p>
                <p>Your goal is to click them in numerical order as fast as you can:</p>
                <p style="font-size: 1.25rem; font-weight: bold; color: var(--primary-color)">1 ➔ 2 ➔ 3 ➔ ...</p>
            </div>`,

            `<div class="card">
                <p>Watch the example below:</p>
                 <div class="demo-board-wrapper">
                    <div class="demo-cursor cursor-anim-a"></div>
                    <div class="demo-grid">
                        <div class="demo-cell demo-active-1">1</div><div class="demo-cell">8</div><div class="demo-cell demo-active-3">3</div><div class="demo-cell">11</div>
                        <div class="demo-cell">14</div><div class="demo-cell demo-active-2">2</div><div class="demo-cell">16</div><div class="demo-cell">5</div>
                        <div class="demo-cell">9</div><div class="demo-cell">6</div><div class="demo-cell demo-active-4">4</div><div class="demo-cell">10</div>
                        <div class="demo-cell">13</div><div class="demo-cell">15</div><div class="demo-cell">7</div><div class="demo-cell">12</div>
                    </div>
                 </div>
                 <p>Click <strong>1</strong>, then <strong>2</strong>, then <strong>3</strong>, then <strong>4</strong>, and so on.</p>
            </div>`
        ],
        show_clickable_nav: true,
        button_label_next: "Next",
        button_label_previous: "Back",
        on_load: () => addSkipButton('A'),
        on_finish: () => removeSkipButton()
    };
    timeline.push(instructionsA_intro);

    // Instructions Part 2 (Start Game)
    const instructionsA_final = {
        type: jsPsychInstructions,
        pages: [
            `<div class="card">
                <p>If you make a mistake, the box will shake and turn red.</p>
                <p>The timer will keep running, so try to be accurate and fast!</p>
                <p>Press <strong>Start Game</strong> to begin Part A.</p>
            </div>`
        ],
        show_clickable_nav: true,
        button_label_next: "Start Game",
        button_label_previous: "Back"
    };

    // Conditional wrapper to skip final instruction if skipped
    const instructionsA_final_node = {
        timeline: [instructionsA_final],
        conditional_function: function () {
            return !window.skipA;
        }
    };
    timeline.push(instructionsA_final_node);

    const PartA = {
        type: jsPsychTrails,
        grid_size: 4,
        trails_type: 'A',
        correct_order: generateSequenceA(),
        random_order: shuffle(generateSequenceA())
    };
    timeline.push(PartA);

    // --- PART B ---
    // Instructions Part 1 (Demo)
    const instructionsB_intro = {
        type: jsPsychInstructions,
        pages: [
            `<div class="card">
                <h2>Part B: Numbers & Letters</h2>
                <p>This part is a bit different. You will see numbers (1-8) and letters (A-H).</p>
                <p>You must alternate between them in order:</p>
                <p style="font-size: 1.25rem; font-weight: bold; color: var(--primary-color)">1 ➔ A ➔ 2 ➔ B ➔ ...</p>
            </div>`,

            `<div class="card">
                <p>Watch the example below (Number, then Letter):</p>
                 <div class="demo-board-wrapper">
                    <div class="demo-cursor cursor-anim-b"></div>
                    <div class="demo-grid">
                        <div class="demo-cell demo-active-1">1</div><div class="demo-cell">H</div><div class="demo-cell demo-active-3">2</div><div class="demo-cell">D</div>
                        <div class="demo-cell">F</div><div class="demo-cell demo-active-2">A</div><div class="demo-cell">E</div><div class="demo-cell">3</div>
                        <div class="demo-cell">5</div><div class="demo-cell">8</div><div class="demo-cell demo-active-4">B</div><div class="demo-cell">G</div>
                        <div class="demo-cell">7</div><div class="demo-cell">C</div><div class="demo-cell">4</div><div class="demo-cell">6</div>
                    </div>
                 </div>
                 <p>Click <strong>1</strong> ➔ <strong>A</strong> ➔ <strong>2</strong> ➔ <strong>B</strong>...</p>
            </div>`
        ],
        show_clickable_nav: true,
        button_label_next: "Next",
        button_label_previous: "Back",
        on_load: () => addSkipButton('B'),
        on_finish: () => removeSkipButton()
    };
    timeline.push(instructionsB_intro);

    // Instructions Part 2 (Start Game)
    const instructionsB_final = {
        type: jsPsychInstructions,
        pages: [
            `<div class="card">
                 <p>Remember: <strong>Number, then Letter.</strong></p>
                 <p>1 ➔ A ➔ 2 ➔ B...</p>
                 <p>Press <strong>Start Game</strong> to begin Part B.</p>
            </div>`
        ],
        show_clickable_nav: true,
        button_label_next: "Start Game",
        button_label_previous: "Back"
    };

    // Conditional wrapper to skip final instruction if skipped
    const instructionsB_final_node = {
        timeline: [instructionsB_final],
        conditional_function: function () {
            return !window.skipB;
        }
    };
    timeline.push(instructionsB_final_node);

    const PartB = {
        type: jsPsychTrails,
        grid_size: 4,
        trails_type: 'B',
        correct_order: generateSequenceB(),
        random_order: shuffle(generateSequenceB())
    };
    timeline.push(PartB);

    // End - Results Summary
    const end_block = {
        type: jsPsychHtmlKeyboardResponse,
        choices: "NO_KEYS",
        stimulus: function () {
            // Retrieve data
            const trials = jsPsych.data.get().filter({ trail_type: 'trails' }); // Custom plugin saves as 'trails' or usually filter by plugin type?
            // Actually better to filter by our custom property 'trails_type' which we save.

            // Get Part A data
            // We used localsave 'csv' but internal data is object.
            // Our plugin saves: { rt, errors, trails_type, grid_size }

            const partA = jsPsych.data.get().filter({ trails_type: 'A' }).values()[0] || { rt: 0, errors: 0 };
            const partB = jsPsych.data.get().filter({ trails_type: 'B' }).values()[0] || { rt: 0, errors: 0 };

            const timeA = (partA.rt / 1000).toFixed(2);
            const timeB = (partB.rt / 1000).toFixed(2);

            return `
                <div class="card">
                    <h2>Task Complete</h2>
                    <p>Thank you for participating!</p>
                    <table>
                        <thead>
                            <tr>
                                <th>Metric</th>
                                <th>Part A</th>
                                <th>Part B</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Time (s)</td>
                                <td>${timeA}</td>
                                <td>${timeB}</td>
                            </tr>
                            <tr>
                                <td>Errors</td>
                                <td>${partA.errors}</td>
                                <td>${partB.errors}</td>
                            </tr>
                        </tbody>
                    </table>
                    <p>Data will be downloaded automatically.</p>
                </div>
            `;
        },
        on_load: function () {
            // 1. CSV Download (Only if NOT embedded)
            if (window.parent === window) {
                jsPsych.data.get().localSave('csv', `grid_trails_jspsych_${subjectId}.csv`);
            }
        }
    };
    timeline.push(end_block);

    // Run
    jsPsych.run(timeline);

</script>

</html>